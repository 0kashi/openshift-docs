// Module included in the following assemblies:
//
// monitoring/monitoring.adoc

[id='exposing-custom-application-metrics-for-horizontal-pod-autoscaling-{context}']
= Exposing custom application metrics for horizontal pod autoscaling

This procedure shows, on an example, how a human operator for the cluster can, using `prometheus-adapter`, expose custom application metrics for the horizontal pod autoscaler.

.Prerequisites

* Make sure you have configured cluster for application monitoring. In this example, it is presumed that Prometheus and Alertmanager instances were installed in the `default` namespace.
* Make sure you have configured monitoring for your application application monitoring. In this example, it is presumed that the application and the service monitor for it were installed in the `default` namespace.

.Procedure

The following steps present snippets of YAML files. For each step, put the snippet into a YAML file, for example, `deploy.yaml` and run this command to apply the configuration file to the cluster:

  $ oc apply -f deploy.yaml

. Create the ??? configuration for `prometheus-adapter`:
+
  kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: custom-metrics-apiserver
    namespace: default
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: custom-metrics-server-resources
  rules:
  - apiGroups:
    - custom.metrics.k8s.io
    resources: ["*"]
    verbs: ["*"]
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: custom-metrics-resource-reader
  rules:
  - apiGroups:
    - ""
    resources:
    - namespaces
    - pods
    - services
    verbs:
    - get
    - list
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: custom-metrics:system:auth-delegator
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: system:auth-delegator
  subjects:
  - kind: ServiceAccount
    name: custom-metrics-apiserver
    namespace: default

. Create the ??? configuration for `prometheus-adapter`:
+
  apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: custom-metrics-auth-reader
    namespace: kube-system
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: extension-apiserver-authentication-reader
  subjects:
  - kind: ServiceAccount
    name: custom-metrics-apiserver
    namespace: default
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: custom-metrics-resource-reader
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: custom-metrics-resource-reader
  subjects:
  - kind: ServiceAccount
    name: custom-metrics-apiserver
    namespace: default
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: hpa-controller-custom-metrics
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: custom-metrics-server-resources
  subjects:
  - kind: ServiceAccount
    name: horizontal-pod-autoscaler
    namespace: kube-system

. Configure the exposed metrics (???) for `prometheus-adapter`:
+
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: adapter-config
    namespace: default
  data:
    config.yaml: |
      rules:
      - seriesQuery: 'http_requests_total{namespace!="",pod!=""}'
        resources:
          overrides:
            namespace: {resource: "namespace"}
            pod: {resource: "pod"}
            service: {resource: "service"}
        name:
          matches: "^(.*)_total"
          as: "${1}_per_second"
        metricsQuery: 'sum(rate(<<.Series>>{<<.LabelMatchers>>}[2m])) by (<<.GroupBy>>)'

. Register `prometheus-adapter` as an API service:
+
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      service.alpha.openshift.io/serving-cert-secret-name: prometheus-adapter-tls
    labels:
      name: prometheus-adapter
    name: prometheus-adapter
    namespace: default
  spec:
    ports:
    - name: https
      port: 443
      targetPort: 6443
    selector:
      app: prometheus-adapter
    type: ClusterIP
  ---
  apiVersion: apiregistration.k8s.io/v1beta1
  kind: APIService
  metadata:
    name: v1beta1.custom.metrics.k8s.io
  spec:
    service:
      name: prometheus-adapter
      namespace: default
    group: custom.metrics.k8s.io
    version: v1beta1
    insecureSkipTLSVerify: true
    groupPriorityMinimum: 100
    versionPriority: 100
  ---

. Deploy `prometheus-adapter`:
+
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    labels:
      app: prometheus-adapter
    name: prometheus-adapter
    namespace: default
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: prometheus-adapter
    template:
      metadata:
        labels:
          app: prometheus-adapter
        name: prometheus-adapter
      spec:
        serviceAccountName: custom-metrics-apiserver
        containers:
        - name: prometheus-adapter
          image: directxman12/k8s-prometheus-adapter-amd64
          args:
          - --secure-port=6443
          - --tls-cert-file=/var/run/serving-cert/tls.crt
          - --tls-private-key-file=/var/run/serving-cert/tls.key
          - --logtostderr=true
          - --prometheus-url=http://prometheus-operated.default.svc:9090/
          - --metrics-relist-interval=1m
          - --v=4
          - --config=/etc/adapter/config.yaml
          ports:
          - containerPort: 6443
          volumeMounts:
          - mountPath: /var/run/serving-cert
            name: volume-serving-cert
            readOnly: true
          - mountPath: /etc/adapter/
            name: config
            readOnly: true
          - mountPath: /tmp
            name: tmp-vol
        volumes:
        - name: volume-serving-cert
          secret:
            secretName: prometheus-adapter-tls
        - name: config
          configMap:
            name: adapter-config
        - name: tmp-vol
          emptyDir: {}

. Now the application's metrics are exposed and can be used to configure horizontal pod autoscaling.

.Additional resources

* For information about Horizontal Pod Autoscaler, see link:https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale[the Kubernetes documentation].
