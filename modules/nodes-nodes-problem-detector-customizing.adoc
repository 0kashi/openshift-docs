// Module included in the following assemblies:
//
// * nodes/nodes-nodes-problem-detector.adoc

[id='nodes-nodes-problem-detector-customizing_{context}']
= Customizing Node Problem Detector conditions

You can configure the Node Problem Detector to watch for any log string by editing the Node Problem Detector configuration map.

.Procedure

To configure the Node Problem Detector, add or remove problem conditions and events.

. Edit the Node Problem Detector configuration map with a text editor.
+
[source,bash]
----
oc edit configmap -n openshift-node-problem-detector node-problem-detector
----
+
.Sample Node Problem Detector Configuration Map
[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: node-problem-detector
data:
    kernel-monitor.json: |  <8>
    {
        "plugin": "journald", <2>
        "pluginConfig": {
                "source": "kernel"
        },
        "logPath": "/host/log/journal", <3>
        "lookback": "5m",
        "bufferSize": 10,
        "source": "kernel-monitor",
        "conditions": [                 <4>
                {
                        "type": "KernelDeadlock", <5>
                        "reason": "KernelHasNoDeadlock", <6>
                        "message": "kernel has no deadlock"  <7>
                }
        ],
        "rules": [
                {
                        "type": "temporary",
                        "reason": "OOMKilling",
                        "pattern": "Kill process \\d+ (.+) score \\d+ or sacrifice child\\nKilled process \\d+ (.+) total-vm:\\d+kB, anon-rss:\\d+kB, file-rss:\\d+kB"
                },
                {
                        "type": "temporary",
                        "reason": "TaskHung",
                        "pattern": "task \\S+:\\w+ blocked for more than \\w+ seconds\\."
                },
                {
                        "type": "temporary",
                        "reason": "UnregisterNetDevice",
                        "pattern": "unregister_netdevice: waiting for \\w+ to become free. Usage count = \\d+"
                },
                {
                        "type": "temporary",
                        "reason": "KernelOops",
                        "pattern": "BUG: unable to handle kernel NULL pointer dereference at .*"
                },
                {
                        "type": "temporary",
                        "reason": "KernelOops",
                        "pattern": "divide error: 0000 \\[#\\d+\\] SMP"
                },
                {
                        "type": "permanent",
                        "condition": "KernelDeadlock",
                        "reason": "AUFSUmountHung",
                        "pattern": "task umount\\.aufs:\\w+ blocked for more than \\w+ seconds\\."
                },
        ]
    }
----

<1> Rules and conditions that apply to container images.
<2> Monitoring services, in a comma-separated list.
<3> Path to the monitoring service log.
<4> List of events to be monitored.
<5> Label to indicate the error is an event (`temporary`) or NodeCondition (`permanent`).
<6> Text message to describe the error.
<7> Error message that the Node Problem Detector watches for.
<8> Rules and conditions that apply to the kernel.

////
https://kubernetes.io/docs/tasks/debug-application-cluster/monitor-node-health/#node-problem-detector
The Node Problem Detector supports file-based kernel logging. However, it is easy to extend it to support other log formats.
////

. Remove, add, or edit any node conditions or events as needed.
+
[source,yaml]
----
{
       "type": <`temporary` or `permanent`>,
       "reason": <free-form text describing the error>,
       "pattern": <log message to watch for>
},
----
+
For example:
+
[source,yaml]
----
{
       "type": "temporary",
       "reason": "UnregisterNetDevice",
       "pattern": "unregister_netdevice: waiting for \\w+ to become free. Usage count = \\d+"
},
----

. Restart running pods to apply the changes. To restart pods, you can delete all existing pods:
+
[source,bash]
----
# oc delete pods -n openshift-node-problem-detector -l name=node-problem-detector
----

. To display Node Problem Detector output to standard output (stdout) and standard error (stderr)
add the following to the configuration map:
+
[source,yaml]
----
spec:
  template:
    spec:
      containers:
      - name: node-problem-detector
        command:
        - node-problem-detector
        - --alsologtostderr=true <1>
        - --log_dir="/tmp" <2>
        - --system-log-monitors=/etc/npd/kernel-monitor.json <3>
----
+
<1> Sends the output to standard output (stdout).
<2> Path to the error log.
<3> Comma-separated path to the plug-in configuration files.

