// Module included in the following assemblies:
//
// * logging/efk-logging-manual-rollout.adoc

[id='efk-logging-manual-rollout-rolling_{context}']
= Performing an Elasticsearch rolling cluster restart

A rolling restart is recommended, when any of the following changes are made:

* nodes on which Elasticsearch pods run require a reboot
* `elasticsearch` configmap
* `elasticsearch-* DeploymentConfig
* new image deployment, or upgrade

.Prerequisite

Set cluster logging to the unmanaged state.

.Procedure

To perform a rolling cluster restart:

. Prevent shard balancing when purposely bringing down nodes using the {product-title} 
link:https://github.com/openshift/origin-aggregated-logging/tree/master/elasticsearch#es_util[*es_util*] tool:
+
----
$ oc exec -c elasticsearch $POD -- es_util --query=_cat/nodes?pretty --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "none" } }'
----

. Once complete, for each deployment you have for an ES cluster, run `oc rollout latest`
to deploy the latest version of the deployment object:
+
----
$ oc rollout latest deployment/<deployment-name>
----
+
You will see a new pod deployed. Once the pod has a ready container, you can
move on to the next deployment.

. Once all the deployments for the cluster have been rolled out, re-enable shard balancing:
+
----
$ oc exec -c elasticsearch <any_es_pod_in_the_cluster> --
          curl -s
          --cacert /etc/elasticsearch/secret/admin-ca \
          --cert /etc/elasticsearch/secret/admin-cert \
          --key /etc/elasticsearch/secret/admin-key \
          -XPUT 'https://localhost:9200/_cluster/settings' \
          -d '{ "transient": { "cluster.routing.allocation.enable" : "all" } }'
----
