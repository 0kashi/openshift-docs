// Module included in the following assemblies:
//
// * logging/efk-logging-kibana.adoc

[id='efk-logging-kibana-exposing-{context}']
= Exposing Kibana as a route with custom certificates


If you want to use custom certificates with Kibana, you must: 

* create a specific re-encrypt route to Kibana;  

* use the Elasticsearch secret created by the Cluster Logging Operator to generate the certificate required for the re-encrypt route.

You cannot modify the default Kibana route.

.Prerequisites

* Cluster logging and Elasticsearch must be installed.

* Set cluster logging to the unmanaged state. In managed state, the Cluster Logging Operator reverts changes made to the `logging-curator` configuration map.

.Procedure 

. Extract the CA cert from the Elasticsearch secret.  

----
oc extract secret/elasticsearch --to=. --keys=admin-ca
----

. Create a re-encrypt route using the contents of the `admin-ca` file` as the destination CA certificate.
+
----
apiVersion: "v1"
kind: "Template"
metadata:
  name: kibana-custom-route-template
objects:
- apiVersion: "v1"
  kind: "Route"
  metadata:
    name: kibana-custom
    namespace: openshift-logging
  spec:
    tls:
      key: |  <1>
          ${KEY}
      certificate: |  <2>
          ${CERT}
      caCertificate: |  <3>
          ${CA_CERT}
      destinationCACertificate: | <4>
          ${DEST_CA_CERT}
      termination: reencrypt
      insecureEdgeTerminationPolicy: Redirect
    to:
      kind: Service
      name: ${SERVICE_NAME}
parameters:
  - name: CA_CERT
    displayName: The browser facing The browser facing custom cacert
    required: true
  - name: CERT
    displayName: The browser facing custom cert
    required: true
  - name: KEY
    displayName: The browser facing custom key
    required: true
  - name: DEST_CA_CERT
    displayName: The cacert generated by the cluster-logging-operator
    required: true
  - name: SERVICE_NAME
    displayName: The name of the kibana service
    value: kibana
----
<1> The contents of your custom key.
<2> The contents of your certificate.
<3> The contents of your CA certificate.
<4> The contents of the *_admin-ca_* file.

. Process and apply the template:
+
----
oc process -f kibana-route.yaml -p CA_CERT="$(cat cacert)" -p CERT="$(cat cert)" -p KEY="$(cat key)" -p DEST_CA_CERT="$(cat admin-ca)" | oc apply -f -
----

