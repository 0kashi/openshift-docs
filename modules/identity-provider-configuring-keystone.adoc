// Module included in the following assemblies:
//
// * authentication/identity_providers/configuring-keystone-identity-provider.adoc

[id='identity-provider-configuring-keystone-{context}']
= Configuring your cluster for Keystone

You might need to take more steps to prepare your cluster for Keystone.

.Procedure

. If you have:
- Already completed the installation of Openshift, then copy the
*_/etc/origin/master/master-config.yaml_* file into a new directory; for example:
+
----
$ cd /etc/origin/master
$ mkdir keystoneconfig; cp master-config.yaml keystoneconfig
----
- Not yet installed {product-title}, then start the {product-title} API server,
specifying the hostname of the (future) {product-title} master and a directory
to store the configuration file created by the start command:
+
----
$ openshift start master --public-master=<apiserver> --write-config=<directory>
----
+
For example:
+
----
$ openshift start master --public-master=https://myapiserver.com:8443 --write-config=keystoneconfig
----
+
[NOTE]
====
If you are installing with Ansible, then you must add the
`identityProvider` configuration to the Ansible playbook.
If you use the following steps to modify your configuration manually after installing with Ansible, then you will lose any modifications whenever you re-run the install tool or upgrade.
====
+
. Edit the new *_keystoneconfig/master-config.yaml_* file's `identityProviders` stanza, and copy the example `KeystonePasswordIdentityProvider` configuration
and paste it to replace the existing stanza:
+

. Make the following modifications to the `identityProviders` stanza:
.. Change the provider `name` ("my_keystone_provider") to match your Keystone server.
This name is prefixed to provider user names to form an identity name.
.. If required,
change `mappingMethod` to control how mappings are established between the
provider's identities and user objects.
.. Change the `domainName` to the domain name of your OpenStack Keystone server. In Keystone, user names are domain-specific. Only a single domain is supported.
.. Specify the `url` to use to connect to your OpenStack Keystone server.
.. Optionally, to authenticate users by Keystone ID instead of Keystone user
name, set `useKeystoneIdentity` to `true`.
.. Optionally, change the `ca` to the certificate bundle to use in order to validate server certificates for the configured URL.
.. Optionally, change the `certFile` to the client certificate to present when making requests to the configured URL.
.. If `certFile` is specified, then you must change the `keyFile` to the key for the client certificate.
. Save your changes and close the file.
. Start the {product-title} API server, specifying the configuration file you just
modified:
+
----
$ openshift start master --config=<path/to/modified/config>/master-config.yaml
----

Once configured, any user logging in to the {product-title} web console will be
prompted to log in using their Keystone credentials.


Once one or more users have logged in, you can run `oc get users` to view a
list of users and verify that users were created successfully:

.Output of `oc get users` command
----
$ oc get users
NAME         UID                                    FULL NAME   IDENTITIES
bobsmith     a0c1d95c-1cb5-11e6-a04a-002186a28631   Bob Smith   keystone:bobsmith <1>
----
<1> Identities in {product-title} are comprised of the identity provider name prefixed to the Keystone user name.
