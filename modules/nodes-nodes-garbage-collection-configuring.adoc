
// Module included in the following assemblies:
//
// * nodes/nodes-nodes-garbage-collection.adoc

[id="nodes-nodes-garbage-collection-configuring_{context}"]
= Configuring garbage collection for containers and images

As an administrator, you can configure how {product-title} performs garbage collection.

.Prerequisites

. Obtain the label associated with the static Machine Config Pool CRD for the type of node you want to configure.
Perform one of the following steps:

.. View the Machine Config Pool:
+
----
$ oc describe machineconfigpool <name>
----
+
For example:
+
[source,yaml]
----
$ oc describe machineconfigpool worker

apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfigPool
metadata:
  creationTimestamp: 2019-02-08T14:52:39Z
  generation: 1
  labels:
    custom-kubelet: small-pods <1>
----
<1> If a label has been added it appears under `labels`.

.. If the label is not present, add a key/value pair:
+
----
$ oc label machineconfigpool worker custom-kubelet=small-pods
----

.Procedure

. Configure container garbage collection:

.. Create a Custom Resource (CR) for your configuration change.
+
.Sample configuration for a container garbage collection CR:
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: gc-container <1>
spec:
  machineConfigPoolSelector:
    matchLabels:
      custom-kubelet: small-pods <2>
  kubeletConfig: 
    EvictionSoft: <3>
    - memory.available<100Mi <4>
    - nodefs.available<10%
    - nodefs.inodesFree<5%
    - imagefs.available<15%
    - imagefs.inodesFree<10%
    EvictionSoftGracePeriod: <5>
    - memory.available=1m30s
    - nodefs.available=1m30s
    - nodefs.inodesFree=1m30s
    - imagefs.available=1m30s
    - imagefs.inodesFree=1m30s
----
<1> Name for the object.
<2> Selector label.
<3> Type of eviction: `EvictionSoft` and `EvictionHard`.
<4> Eviction thresholds based on a specific eviction trigger signal.
<5> Grace periods for the soft eviction. This parameter does not apply to `eviction-hard`.

.. Create the object:
+
----
$ oc create -f <file-name>.yaml
----
+
For example:
+
----
oc create -f gc-container.yaml

kubeletconfig.machineconfiguration.openshift.io/gc-container created
----

. Configure image garbage collection:

.. Create a Custom Resource (CR) for your configuration change.
+
.Sample configuration for an image garbage collection CR:
[source,yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: gc-image <1>
spec:
  machineConfigPoolSelector:
    matchLabels:
      custom-kubelet: small-pods <2>
  kubeletConfig:
    imageGCHighThresholdPercent: <3>
    - "85"
    imageGCLowThresholdPercent: <4>
    - "80"
----
<1> Assign a name to the object.
<2> Add the selector label.
<3> The percent of disk usage (expressed as an integer) which triggers image garbage collection.
<4> The percent of disk usage (expressed as an integer) to which image garbage collection attempts to free. 

.. Create the object:
+
----
$ oc create -f <file-name>.yaml
----
+
For example:
+
----
oc create -f gc-image.yaml

kubeletconfig.machineconfiguration.openshift.io/gc-image created
----

. Verify that garbage collection is active. The machineConfigPool you specified in the custom resource appears with `UPDATING` as 'true` until the change is fully implemented:
+
----
$ oc get machineconfigpool

NAME     CONFIG                                   UPDATED   UPDATING
master   rendered-master-546383f80705bd5aeaba93   True      False
worker   rendered-worker-b4c51bb33ccaae6fc4a6a5   False     True
----
