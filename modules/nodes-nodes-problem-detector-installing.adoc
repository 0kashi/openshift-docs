// Module included in the following assemblies:
//
// * nodes/nodes-nodes-problem-detector.adoc

[id="nodes-nodes-problem-detector-installing-{context}"]
= Installing the {product-title} Node Problem Detector

You can use the {product-title} console to install the Node Problem Detector Operator.

.Prerequisites

. Create a Project for the NPD:
+
----
$ oc adm new-project openshift-node-problem-detector --node-selector ""
----

.Procedure

The process to install the Node Problem Detector involves installing the Node Problem Detector Operator and creating a Node Problem Detector instance.

. Install the Node Problem Detector Operator:

.. In the {product-title} console, click *Catalog* -> *Operator Hub*. 

.. Choose  *Node Problem Detector* from the list of available Operators, and click *Install*.

.. On the *Create Operator Subscription* page, under *A specific namespace on the cluster* select *openshift-node-problem-detector*.
Then, click *Subscribe*.

. Verify the operator installations:

.. Switch to the *Catalog* → *Installed Operators* page. 

.. Ensure that *Node Problem Detector* is listed on 
the *InstallSucceeded* tab with a *Status* of *InstallSucceeded*. Change the project to *openshift-node-problem-detector* if necessary.
+
If either operator does not appear as installed, to troubleshoot further: 

* On the *Copied* tab of the *Installed Operators* page, if an operator show a *Status* of
*Copied*, this indicates the installation is in process and is expected behavior.
* Switch to the *Catalog* → *Operator Management* page and inspect 
the *Operator Subscriptions* and *Install Plans* tabs for any failure or errors 
under *Status*. 
* Switch to the *Workloads* → *Pods* page and check the logs in any Pods in the 
`openshift-logging` and `openshift-operators` projects that are reporting issues.

. Create a cluster logging instance:

.. Switch to the the *Administration* -> *CRD* page. 

.. On the *Custom Resource Definitions* page, click *NodeProblemDetector*. 

.. On the *Node Problem Detector* page, click *Create Node Problem Detector*.
+
You might need to refresh the page to load the data.

.. Specify a name and enter the *openshift-node-problem-detector* namespace.
+
[source,yaml]
----
apiVersion: node-problem-detector.operator.k8s.io/v1alpha1
kind: NodeProblemDetector
metadata:
  name: nodeproblemdetectors.node-problem-detector.operator.k8s.io <1>
  namespace: openshift-node-problem-detector <2>
spec: {}
----
<1> Specify a name for the Node Problem Detector.
<2> Specify `openshift-node-problem-detector` as the namespace.

//Beta steps https://bugzilla.redhat.com/show_bug.cgi?id=1679467

. Create a Node Problem Detector RBAC (RBAC):
+
[source,yaml]
----
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
rules:
- apiGroups:
  - node-problem-detector.operator.k8s.io
  resources:
  - "*"
  verbs:
  - "*"
- apiGroups:
  - ""
  resources:
  - pods
  - events
  - configmaps
  - secrets
  - services
  - endpoints
  - serviceaccounts
  verbs:
  - "*"
- apiGroups:
  - apps
  resources:
  - daemonsets
  verbs:
  - "*"

--

kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
subjects:
- kind: ServiceAccount
  name: node-problem-detector-operator
roleRef:
  kind: Role
  name: node-problem-detector-operator
  apiGroup: rbac.authorization.k8s.io

---

kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-node-problem-detector-operator
rules:
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  # the operator needs to be able to bind the cluster role
  # system:node-problem-detector to the node-problem-detector service account
  - clusterrolebindings
  verbs:
  - "*"
- apiGroups:
  - security.openshift.io
  resources:
  # the operator needs to be able to add the node-problem-detector service account
  # to the list of accounts that can use the privileged SCC
  - securitycontextconstraints
  verbs:
  - "*"

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: openshift-node-problem-detector-operator-1
subjects:
- kind: ServiceAccount
  name: node-problem-detector-operator
  namespace: openshift-node-problem-detector
roleRef:
  kind: ClusterRole
  name: openshift-node-problem-detector-operator
  apiGroup: rbac.authorization.k8s.io
----

. Create the objects:
+
----
$ oc create -f deploy/rbac.yaml
$ oc create -f deploy/operator.yaml
$ oc create -f deploy/cr.yaml
----

. Create a Node Problem Detector custom resource (CR):
+
[source,yaml]
----
apiVersion: node-problem-detector.operator.k8s.io/v1alpha1
kind: NodeProblemDetector
metadata:
  name: node-problem-detector
namespace: openshift-node-problem-detector
----

. Configure the Node Problem Detector policy as needed and click *Create*.

.. Click *Create*. This creates the Node Problem Detector Custom Resource, which you
can edit to make changes to the NPD.


