// Module included in the following assemblies:
//
// * logging/efk-logging-curator.adoc

[id="efk-logging-curator-actions-{context}"]
= Preventing Curator from deleting internal indices

The Cluster Logging Operator installation creates a *Curator* ConfigMap, which contains three sections: the Curator `actions` file, a `config.yaml` file, and a `curator5` file.  

* *actions*. In {product-title} cluster logging, the Curator `actions` file supports only the *delete_indices* action.
* *curator5.yaml*. The `curator5.yaml` is the  {product-title} equivalent to the Curator congifuration file.
* *config.yaml*. The `config.yaml` is a legacy  {product-title} configuration file for Curator. 

The `curator5.yaml` and `actions` file are the {product-title} configuration files for curator 5.2. 

[NOTE]
====
The `actions` and `config.yaml` are mutually-exclusive configuration files.  Once the `actions` file exist, {product-title} ignores the `config.yaml` file.
====

If you are an advanced Curator user and want to configure other Curator actions, you can edit the Curator `actions` file, or, if you have an existing Curator `actions` file, you can continue to use that file. However, becasue modifying the `actions` file can be destructive to the cluster and can cause removal of required indices/settings from Elasticsearch, you should use the {product-title} custom configuration file, *_config.yaml_* to remove indices.  

.Prerequisite

* Cluster logging and Elasticsearch must be installed.

* Set cluster logging to the unmanaged state.

.Procedure

To configure Curator to delete indices: 

. Edit the Curator ConfigMap:
+
----
oc edit cm/curator -n openshift-logging
----

. Make the following changes to the `action` file:
+
[source,yaml]
----
actions:
1:
      action: delete_indices <1>
      description: >-
        Delete .operations indices older than 30 days.
        Ignore the error if the filter does not
        result in an actionable list of indices (ignore_empty_list).
        See https://www.elastic.co/guide/en/elasticsearch/client/curator/5.2/ex_delete_indices.html
      options:
        # Swallow curator.exception.NoIndices exception
        ignore_empty_list: True
        # In seconds, default is 300
        timeout_override: ${CURATOR_TIMEOUT}
        # Don't swallow any other exceptions
        continue_if_exception: False
        # Optionally disable action, useful for debugging
        disable_action: False
      # All filters are bound by logical AND
      filters:            <2>
      - filtertype: pattern
        kind: regex
        value: '^\.operations\..*$'
        exclude: False    <3>
      - filtertype: age
        # Parse timestamp from index name
        source: name
        direction: older
        timestring: '%Y.%m.%d'
        unit: days
        unit_count: 30
        exclude: False
----
<1> Specify `delete_indices` to delete the specified index.
<2> Use the `filers` parameters to specify the index to be deleted. See the link:https://www.elastic.co/guide/en/elasticsearch/client/curator/5.2/filters.html[Elastic Search curator documentation] for information on these parameters. 
<3> Specify `false` to allow the index to be deleted.

