// Module included in the following assemblies:
//
// * upgrading/upgrading-cluster.adoc

[id='upgrade-upgrading-cli-{context}']
= Updating a cluster by using the CLI

If updates are available, you can update your cluster by using the `oc` command
line interface (CLI).

.Prerequisites

* Have access to the CLI as a user with `admin` privileges.
* Install the `jq` package.


.Procedure

. Ensure that your cluster is available:
+
----
$ oc get clusterversion

NAME      VERSION     AVAILABLE   PROGRESSING   SINCE     STATUS
version   4.0.0-0.6   True        False         12m       Cluster version is 4.0.0-0.6
----

. Review the current update channel information:
+
----
$ oc get clusterversion -o json|jq ".items[0].spec"

{
  "channel": "stable-4.0",
  "clusterID": "53f97452-9956-4a3c-8260-00c1de2668a1",
  "upstream": "https://api.openshift.com/api/upgrades_info/v1/graph"
}
----

. For non-production clusters, you can modify the specification that describes
the cluster version state that you want:
+
----
$ oc edit clusterversions.config.openshift.io
----
+
See the `ClusterVersion` object definition that follows.

. Ensure update graph is available from the update server:
+
----
$ curl https://openshift-release.svc.ci.openshift.org/graph
----

. View the available updates and note the version number of the update that
you want to apply:
+
----
$ oc adm upgrade

Cluster version is 4.0.0-0.nightly-2019-01-25-200832
Updates:
VERSION                       	IMAGE
4.0.0-0.nightly-2019-01-25-201056 registry.svc.ci.openshift.org/ocp/release:4.0.0-0.nightly-2019-01-25-201056
4.0.0-0.nightly-2019-01-25-205123 registry.svc.ci.openshift.org/ocp/release:4.0.0-0.nightly-2019-01-25-205123
----

. Apply the update:
+
----
$ oc adm upgrade --to=<version> <1>
----
<1> `<version>` is the update version that you obtained from the output of the
previous command.

. Review the status of the Cluster Version Operator:
+
----
$ oc get clusterversion -o json|jq ".items[0].spec"

{
  "channel": "stable-4.0",
  "clusterID": "53f97452-9956-4a3c-8260-00c1de2668a1",
  "desiredUpdate": {
	"image": "registry.svc.ci.openshift.org/ocp/release:4.0.0-0.nightly-2019-01-25-201056",
	"version": "4.0.0-0.nightly-2019-01-25-201056" <1>
  },
  "upstream": "https://openshift-release.svc.ci.openshift.org/graph"
}
----
<1> If the `version` number in the `desiredUpdate` stanza matches the value that
you specified, the update is in progress.

. Review the cluster version status history to monitor the status of the update.
It might take some time for all the objects to finish updating.
+
----
$ oc get clusterversion -o json|jq ".items[0].status.history"

[
  {
	"completionTime": null,
	"image": "registry.svc.ci.openshift.org/ocp/release:4.0.0-0.nightly-2019-01-25-201056",
	"startedTime": "2019-01-29T07:51:34Z",
	"state": "Partial",
	"version": "4.0.0-0.nightly-2019-01-25-201056"
  },
  {
	"completionTime": "2019-01-29T07:51:34Z",
	"image": "registry.svc.ci.openshift.org/ocp/release@sha256:8aed3ea045e740d46fe96c864f016b5d36570bd16d4c7cc7a8a1dafdd670cdba",
	"startedTime": "2019-01-29T06:29:32Z",
	"state": "Completed",
	"version": "4.0.0-0.nightly-2019-01-25-200832"
  }
]
----
+
The history contains a list of the most recent versions applied to the cluster.
This value is updated when the CVO applies an update. The list is ordered by
date, where the newest update is first in the list. Updates in the history have
state `Completed` if the rollout completed and `Partial` if the update failed
or did not complete.
+
[IMPORTANT]
====
If an upgrade fails, the Operator stops and reports the status of the failing
component. Rolling your cluster back to a previous version is not supported.
====

. After the update completes, you can confirm that the Cluster Version Operator
is using the new image:
+
----
$ oc describe deployment cluster-version-operator |grep image

--release-image=registry.svc.ci.openshift.org/ocp/release:4.0.0-0.nightly-2019-01-25-201056
----

